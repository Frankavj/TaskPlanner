<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User</title>
    <link rel="stylesheet" href="../css/user.css">
</head>

<body>

    <button class="back" id="btnBack">Â«</button>
    <div class="main">
        <img id="avatar" src="../img/boy_2.png">
        <div class="container" id="container"></div>
    </div>

</body>

<script>

    let container = document.getElementById("container");
    let btnBack = document.getElementById('btnBack');

    // Get line img
    let line = document.createElement('img');
    line.setAttribute("src", "../img/line.png");
    line.setAttribute("class", "line");

    let url = "http://localhost:3000/users";

    btnBack.addEventListener('click', function () {
        window.location.href = "./index.html";
    });

    let logindata = JSON.parse(sessionStorage.getItem("logindata"));
    if (!logindata) {
        window.location.href = "./userlogin.html";
    }
    let token = logindata.token;


    // ---------------------------------------
    async function showUser() {
        // now shows all users - will be just the one that's logged in once we have authentication
        try {

            let cfg = {
                method: "GET",
                headers: { "authorisation": token }
            };

            var resp = await fetch(url, cfg);
            var user = await resp.json();

            if (resp.status == 403) {
                // If user hasn't logged in, go to the login page
                window.location.href = "./userlogin.html";
                return;
            } else if (resp.status > 202) {
                throw (user);
            }

            container.innerHTML = ""; // delete previous content

            // Add username and email
            let profileDiv = document.createElement('div');
            let html = `<div class="username">${user.username}</div>
                        <div class="email">${user.email}</div>`;
            profileDiv.innerHTML = html;
            container.appendChild(profileDiv);

            // Change email button
            let emailDiv = document.createElement('div');
            let btnEmail = document.createElement('button');
            btnEmail.innerHTML = "Change email";
            btnEmail.addEventListener('click', function (evt) {
                window.location.href = "./userupdate.html";
                localStorage.setItem('update', "email");
            });
            btnEmail.setAttribute("class", "btnEmail");
            emailDiv.appendChild(btnEmail);
            emailDiv.appendChild(line.cloneNode(true));
            container.appendChild(emailDiv);

            // Change username button
            let unameDiv = document.createElement('div');
            let btnUsername = document.createElement('button');
            btnUsername.innerHTML = "Change username";
            btnUsername.addEventListener('click', function (evt) {
                window.location.href = "./userupdate.html";
                localStorage.setItem('update', "username");
            });
            btnUsername.setAttribute("class", "btnUsername");
            unameDiv.appendChild(btnUsername);
            unameDiv.appendChild(line.cloneNode(true));
            container.appendChild(unameDiv);

            // Change password button
            let pwdDiv = document.createElement('div');
            let btnPwd = document.createElement('button');
            btnPwd.innerHTML = "Reset password";
            btnPwd.addEventListener('click', function (evt) {
                window.location.href = "./userupdate.html";
                localStorage.setItem('update', "password");
            });
            btnPwd.setAttribute("class", "btnPwd");
            pwdDiv.appendChild(btnPwd);
            pwdDiv.appendChild(line);
            container.appendChild(pwdDiv);

            // Delete button
            let btnDelete = document.createElement('button');
            btnDelete.innerHTML = "Delete account";
            btnDelete.addEventListener('click', function (evt) {
                if (confirm("Are you sure you want to delete your account?")) {
                    deleteUser(user.id);
                }
            });
            container.appendChild(btnDelete);
            btnDelete.setAttribute("class", "btnDelete");

            // Log out button
            let btnLogOut = document.createElement('button');
            btnLogOut.innerHTML = "Log out";
            btnLogOut.addEventListener('click', function (evt) {
                sessionStorage.removeItem('logindata');
                window.location.href = "./userlogin.html";
            });
            btnLogOut.setAttribute("class", "logout");
            container.appendChild(btnLogOut);

        } catch (err) {
            console.log(err);
        }
    }

    // --------------------------------------- 

    async function deleteUser(id) {

        let updata = { userid: id };
        let cfg = {
            method: "DELETE",
            headers: {
                "Content-Type": "application/json"
                , "authorisation": token
            },
            body: JSON.stringify(updata)
        }

        try {
            let resp = await fetch(url, cfg);
            var data = await resp.json();
            window.location.href = "./userlogin.html";
        }
        catch (err) {
            console.log(err);
        }

    }

    showUser();

</script>

</html>