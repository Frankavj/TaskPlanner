<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My document</title>
    <link rel="stylesheet" href="../css/index.css">
</head>

<body>


    <!-- In sidebar -->


    <div class="list">
        <img src="boy_2.png" id="myProfile">
        <h2 id="allLists">Public Lists</h2>
  
    <div id="myList"> 
        <h2>My Lists</h2>
        
        <h4 id="private">Private</h4>
        <div id="privateLists"></div>

        <h4 id="public">Public</h4>
        <div id="publicLists"></div>

        <!-- To be used when we implement individual lists -->
        <h4 id="individual">Shared with me</h4>
        <div id="individualLists"></div>
    </div>

        <img src="add.png" id="createListSidebar">

        <button id="logout">Log Out</button>

        <!--list class ends-->
    </div>



    <!-- Not in sidebar -->

    <div class="home">

        <h2 id="listTitle" contenteditable="true">Welcome back!</h2>

        <!--style= "border-width: 1; border: solid; color: grey";-->

        <h3 id="columnL">Private Lists</h3>
        <div id="containerL">
            <img id="createList" src="add_home.png" />
        </div>

        <h3 id="columnR">Public Lists</h3>
        <div id="containerR">
            <img id="createList" src="add_home.png" />
        </div>

        <button id="btnShare" style="display:none"></button>
        <button id="btnAddPeople" style="display:none">Add people</button>
        <button id="btnListDelete" style="display:none">Delete</button>

    </div>
    <!--list class ends-->


</body>

<script>

    let logindata = JSON.parse(sessionStorage.getItem("logindata"));
    if (!logindata) {
        window.location.href = "./userlogin.html";
    }
    let token = logindata.token;

    // redirect to other pages ----------------------------------------------------------------------------
    let createListSidebar = document.getElementById('createListSidebar');
    let createList = document.getElementById('createList');
    let btnMyProfile = document.getElementById('myProfile');
    let btnLogout = document.getElementById('logout');

    createListSidebar.addEventListener('click', function () {
        window.location.href = "./listcreate.html";
    });

    btnMyProfile.addEventListener('click', function () {
        window.location.href = "./user.html";
    });

    btnLogout.addEventListener('click', function () {
        sessionStorage.removeItem('logindata');
        window.location.href = "./userlogin.html";
    });


    // sidebar expand/collapse -----------------------------------------------------------------------------
    let privateHeader = document.getElementById('private');
    let privateContainer = document.getElementById('privateLists');
    let publicHeader = document.getElementById('public');
    let publicContainer = document.getElementById('publicLists');
    let individualHeader = document.getElementById('individual');
    let individualContainer = document.getElementById('individualLists');

    let btnShare = document.getElementById('btnShare');
    let btnAddPeople = document.getElementById('btnAddPeople');
    let btnListDelete = document.getElementById('btnListDelete');

    privateHeader.addEventListener('click', function () {
        toggleLists(privateContainer, "private");
    });

    publicHeader.addEventListener('click', function () {
        toggleLists(publicContainer, "public");
    });

    individualHeader.addEventListener('click', function () {
        toggleLists(individualContainer, "individual");
    });

    function toggleLists(container, shared) {
        if (container.innerHTML == "") {
            showLists(container, shared);
        } else {
            container.innerHTML = "";
        }
    }


    // GET all public lists ---------------------------------------------------------------------------------
    let allLists = document.getElementById('allLists');
    let leftHeader = document.getElementById('columnL');
    let leftContainer = document.getElementById('containerL');
    let rightHeader = document.getElementById('columnR');
    let rightContainer = document.getElementById('containerR');

    allLists.addEventListener('click', function () {
        showLists(leftContainer, "allpublic");
        leftHeader.innerHTML = "Lists";
        rightContainer.style = "display:none";
        rightHeader.style = "display:none";
    });


    // GET private and public lists of user (homepage) ------------------------------------------------------
    showLists(leftContainer, "private");
    showLists(rightContainer, "public");


    // GET list ---------------------------------------------------------------------------------------------
    async function showLists(container, shared) {
        btnShare.style = "display:none";
        btnAddPeople.style = "display:none";
        btnListDelete.style = "display:none";

        try {
            let url = `http://localhost:3000/lists/${shared}`;

            let cfg = {
                method: "GET",
                headers: { "authorisation": token }
            };

            var resp = await fetch(url, cfg);
            var data = await resp.json();

            if (resp.status == 403) {
                //If user hasn't logged in, go to the login page
                window.location.href = "./userlogin.html";
                return;
            } else if (resp.status > 202) {
                throw (data);
            }

            container.innerHTML = ""; // delete previous content

            for (let value of data) {

                let div = document.createElement('div');
                let html;
                html = `<p>${value.name}</p>`;
                div.innerHTML = html;

                div.addEventListener('click', function (evt) {
                    localStorage.setItem('listinfo', JSON.stringify(value));
                    openList();
                });

                if (!shared.localeCompare("allpublic")) {
                    // get the name of the owner and desplay it
                    url = `http://localhost:3000/users/${value.owner}`;

                    cfg = {
                        method: "GET",
                        headers: { "authorisation": token }
                    }

                    var resp = await fetch(url, cfg);
                    var user = await resp.json();

                    if (resp.status == 403) {
                        // If user hasn't logged in, go to the login page
                        window.location.href = "./userlogin.html";
                        return;
                    } else if (resp.status > 202) {
                        throw (user);
                    }

                    let owner = document.createElement('p');
                    owner.innerHTML = `Shared by ${user.username}`;

                    div.appendChild(owner);

                }

                container.appendChild(div);
            }

            // add the createlist button again
            let createList = document.createElement('img');
            createList.setAttribute('id', 'createList');
            createList.setAttribute('src','add_home.png');

            createList.addEventListener('click', function () {
                window.location.href = "./listcreate.html";
            });

            container.appendChild(createList);

        } catch (err) {
            console.log(err);
        }
    }


    // Details list -----------------------------------------------------------------------------------------
    let title = document.getElementById('listTitle');
    let btnCreateTask = document.createElement('button');
    btnCreateTask.innerHTML = "Add Task";

    async function openList() {

        let list = JSON.parse(localStorage.getItem('listinfo'));
        title.innerHTML = list.name;

        rightContainer.style = "display:block";
        rightHeader.style = "display:block";

        leftHeader.innerHTML = "Tasks";
        rightHeader.innerHTML = "Completed tasks";

        leftContainer.innerHTML = "";
        rightContainer.innerHTML = "";

        loadTasks();

        btnCreateTask.addEventListener('click', function () {
            ///TODO create new task
        });

        // show share, addPeople and delete btns based on shared property of this list
        if (list.shared == 0 || list.shared == 2) {
            // private or individual
            // later: change img src, for now use btns
            btnShare.style = "display:block";
            btnShare.innerHTML = "Share";
            btnAddPeople.style = "display:block";
        } else if (list.shared == 1) {
            // later: change img src, for now use btns
            btnShare.style = "display:block";
            btnShare.innerHTML = "Unshare";
            btnAddPeople.style = "display:none";
        }
        btnListDelete.style = "display:block";
    }


    // PUT list --------------------------------------------------------------------------------------------
    // name ----------------------------------------------------
    title.addEventListener('keydown', function (evt) {
        if (event.keyCode == 13) {
            evt.preventDefault();
            updateList("name", title.innerHTML);
        }
    });

    // shared --------------------------------------------------
    btnShare.addEventListener('click', function () {
        let list = JSON.parse(localStorage.getItem('listinfo'));
        if (list.shared == 1) {
            //public
            updateList("shared", 0);
        } else {
            //private or individual
            updateList("shared", 1);
            //public lists don't have individual access
            updateList("individual_access", "NULL");
        }
    });

    // individual access ---------------------------------------
    btnAddPeople.addEventListener('click', function () {
        ///TODO give users individual access
    });

    // PUT list ------------------------------------------------
    async function updateList(feature, value) {

        if (!value && value !== 0) {
            return;
        }

        let list = JSON.parse(localStorage.getItem('listinfo'));

        let url = `http://localhost:3000/lists`;

        let updata = {
            update: feature,
            value: value,
            listid: list.id
        }

        let cfg = {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
                "authorisation": token
            },
            body: JSON.stringify(updata)
        }

        try {

            var resp = await fetch(url, cfg);
            var data = await resp.json();

            if (resp.status == 403) {
                window.location.href = "./userlogin.html";
                return;
            } else if (resp.status > 202) {
                throw (data);
            }

            // Everything OK: reload list
            if (!feature.localeCompare("name")) {
                privateContainer.innerHTML = "";
                publicContainer.innerHTML = "";
                individualContainer.innerHTML = "";

                list.name = value;
                localStorage.setItem('listinfo', JSON.stringify(list));

                openList();
            } else {
                window.location.reload();
            }

        } catch (err) {
            console.log(err);
        }
    }


    // DELETE list -------------------------------------------------------------------------------------------
    btnListDelete.addEventListener('click', function () {
        let list = JSON.parse(localStorage.getItem('listinfo'));
        deleteList(list.id);
    });

    async function deleteList(id) {

        let url = "http://localhost:3000/lists";

        let updata = { listid: id };
        let cfg = {
            method: "DELETE",
            headers: {
                "Content-Type": "application/json",
                "authorisation": token
            },
            body: JSON.stringify(updata)
        }

        try {
            await fetch(url, cfg);
            window.location.reload();
        } catch (err) {
            console.log(err);
        }
    }


    // GET tasks ---------------------------------------------------------------------------------------------
    async function loadTasks() {
        showTasks(rightContainer, 1);
        await showTasks(leftContainer, 0);
        leftContainer.appendChild(btnCreateTask);
    }

    async function showTasks(container, completed) {

        let list = JSON.parse(localStorage.getItem('listinfo'));

        try {
            let url = `http://localhost:3000/tasks/${list.id}/${completed}`;

            let cfg = {
                method: "GET",
                headers: { "authorisation": token }
            };

            var resp = await fetch(url, cfg);
            var data = await resp.json();

            if (resp.status == 403) {
                //If user hasn't logged in, go to the login page
                window.location.href = "./userlogin.html";
                return;
            } else if (resp.status > 202) {
                throw (data);
            }

            container.innerHTML = ""; // delete previous content

            for (let value of data) {

                let div = document.createElement('div');

                ///TODO replace by img
                let checkbox = document.createElement('button');
                if (!completed) {
                    checkbox.innerHTML = "Check";
                    checkbox.addEventListener('click', function () {
                        updateTask(value.id, "completed", 1);
                    });
                } else {
                    checkbox.innerHTML = "Uncheck";
                    checkbox.addEventListener('click', function () {
                        updateTask(value.id, "completed", 0);
                    });
                }
                div.appendChild(checkbox);

                let taskName = document.createElement('p');
                taskName.innerHTML = value.name;
                taskName.contentEditable = true;
                taskName.addEventListener('keydown', function (evt) {
                    if (event.keyCode == 13) {
                        evt.preventDefault();
                        updateTask(value.id, "name", taskName.innerHTML);
                    }
                });
                div.appendChild(taskName);

                ///TODO replace by img
                let btnTaskDelete = document.createElement('button');
                btnTaskDelete.innerHTML = "Delete";
                btnTaskDelete.addEventListener('click', function () {
                    deleteTask(value.id);
                });
                div.appendChild(btnTaskDelete);

                container.appendChild(div);
            }
        } catch (err) {
            console.log(err);
        }
    }


    // PUT tasks ----------------------------------------------------------------------------------------------
    async function updateTask(taskid, feature, value) {

        if (!value && value !== 0) {
            return;
        }

        let url = `http://localhost:3000/tasks/`;

        let updata = {
            update: feature,
            value: value,
            taskid: taskid
        }

        let cfg = {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
                "authorisation": token
            },
            body: JSON.stringify(updata)
        }

        try {

            var resp = await fetch(url, cfg);
            var data = await resp.json();

            if (resp.status == 403) {
                window.location.href = "./userlogin.html";
                return;
            } else if (resp.status > 202) {
                throw (data);
            }

            // Everything OK: reload
            loadTasks();

        } catch (err) {
            console.log(err);
        }
    }


    // DELETE tasks ------------------------------------------------------------------------------------------
    async function deleteTask(id) {

        let url = "http://localhost:3000/tasks";

        let updata = { taskid: id };
        let cfg = {
            method: "DELETE",
            headers: {
                "Content-Type": "application/json",
                "authorisation": token
            },
            body: JSON.stringify(updata)
        }

        try {
            await fetch(url, cfg);
            loadTasks();
        } catch (err) {
            console.log(err);
        }
    }

</script>

</html>