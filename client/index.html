<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My document</title>
</head>

<body>

    <!-- In sidebar -->
    <button id="myProfile"></button>
    <h2 id="allLists">Public Lists</h2>
    <div id="allListsContainer"></div>

    <h2>My Lists</h2>

    <h4 id="private">Private</h4>
    <div id="privateLists"></div>

    <h4 id="public">Public</h4>
    <div id="publicLists"></div>

    <!-- To be used when we implement individual lists -->
    <h4 id="individual">Shared with me</h4>
    <div id="individualLists"></div>

    <button id="createListSidebar">+</button>

    <button id="logout">Log Out</button>

    <!-- Not in sidebar -->
    <h2 id="listTitle">Welcome Back!</h2>
    <input id="changeListName" type="text" style="display: none;">

    <h3 id="columnL">Private Lists</h3>
    <div id="containerL"></div>

    <h3 id="columnR">Public Lists</h3>
    <div id="containerR"></div>

    <button id="createList">Create new list</button>

</body>

<script>

    let btnMyProfile = document.getElementById('myProfile');
    let allLists = document.getElementById('allLists');
    let allListsContainer = document.getElementById('allListsContainer');

    let privateHeader = document.getElementById('private');
    let privateContainer = document.getElementById('privateLists');
    let publicHeader = document.getElementById('public');
    let publicContainer = document.getElementById('publicLists');
    let individualHeader = document.getElementById('individual');
    let individualContainer = document.getElementById('individualLists');

    let createListSidebar = document.getElementById('createListSidebar');
    let btnLogout = document.getElementById('logout');

    let title = document.getElementById('listTitle');
    let changeListName = document.getElementById('changeListName');

    let leftHeader = document.getElementById('columnL');
    let leftContainer = document.getElementById('containerL');
    let rightHeader = document.getElementById('columnR');
    let rightContainer = document.getElementById('containerR');
    let createList = document.getElementById('createList');

    let logindata = JSON.parse(sessionStorage.getItem("logindata"));
    if (!logindata) {
        window.location.href = "./userlogin.html";
    }
    let token = logindata.token;

    myProfile.innerHTML = logindata.username;

    createListSidebar.addEventListener('click', function () {
        window.location.href = "./listcreate.html";
    });

    createList.addEventListener('click', function () {
        window.location.href = "./listcreate.html";
    });

    btnMyProfile.addEventListener('click', function () {
        window.location.href = "./user.html";
    });

    allLists.addEventListener('click', function () {
        toggleLists(allListsContainer, "allpublic");
    });

    privateHeader.addEventListener('click', function () {
        toggleLists(privateContainer, "private");
    });

    publicHeader.addEventListener('click', function () {
        toggleLists(publicContainer, "public");
    });

    individualHeader.addEventListener('click', function () {
        toggleLists(individualContainer, "individual");
    });

    btnLogout.addEventListener('click', function () {
        sessionStorage.removeItem('logindata');
        window.location.href = "./userlogin.html";
    });

    // show list in sidebar ---------------------------------------
    function toggleLists(container, shared) {
        if (container.innerHTML == "") {
            showLists(container, shared);
        } else {
            container.innerHTML = "";
        }
    }

    // show lists in any container --------------------------------
    async function showLists(container, shared) {
        try {
            let url = `http://localhost:3000/lists/${shared}`;

            let cfg = {
                method: "GET",
                headers: { "authorisation": token }
            };

            var resp = await fetch(url, cfg);
            var data = await resp.json();

            if (resp.status == 403) {
                // If user hasn't logged in, go to the login page
                window.location.href = "./userlogin.html";
                return;
            } else if (resp.status > 202) {
                throw (data);
            }

            container.innerHTML = ""; // delete previous content

            for (let value of data) {

                let div = document.createElement('div');
                let html;
                html = `<p>${value.name}</p>`;
                div.innerHTML = html;

                div.addEventListener('click', function (evt) {
                    openList(value.id, value.name);
                });

                container.appendChild(div);
            }
        } catch (err) {
            console.log(err);
        }
    }

    showLists(leftContainer, "private");
    showLists(rightContainer, "public");

    // open list by id (inclused showing tasks) -------------------
    async function openList(id, name) {
        title.innerHTML = name;

        localStorage.setItem("listinfo", JSON.stringify({ id: id, name: name }))

        title.addEventListener('dblclick', function () {
            title.style = "display: none";
            changeListName.value = name;
            changeListName.style = "display:block";
        });

        leftHeader.innerHTML = "Tasks";
        rightHeader.innerHTML = "Completed tasks";

        leftContainer.innerHTML = "";
        rightContainer.innerHTML = "";
        /// TODO: show tasks in the two containers (left and right)
        /// TODO: add button for making new task, delete the one for making new list


    }

    changeListName.addEventListener('keydown', function () {
        if (event.keyCode == 13) {
            let currentlist = JSON.parse(localStorage.getItem("listinfo"));
            updateList("name", changeListName.value, currentlist.id, currentlist.name);
        }
    });

    // update list ------------------------------------------------
    async function updateList(feature, value, listID, listName) {
        if (!value) {
            return;
        }

        let url = `http://localhost:3000/lists/${listID}`;

        let updata = {
            update: feature,
            value: value,
            listID: listID
        }

        let cfg = {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
                "authorisation": token
            },
            body: JSON.stringify(updata)
        }

        try {

            var resp = await fetch(url, cfg);
            var data = await resp.json();

            if (resp.status == 403) {
                window.location.href = "./userlogin.html";
                return;
            } else if (resp.status > 202) {
                throw (data);
            }

            // Everything OK: reload list
            if (!feature.localeCompare("name")) {
                title.style = "display:block";
                changeListName.style = "display:none";
                privateContainer.innerHTML = "";
                publicContainer.innerHTML = "";
                individualContainer.innerHTML = "";
                openList(listID, value);
            } else {
                openList(listID, listName);
            }

        } catch (err) {
            console.log(err);
        }
    }

</script>

</html>