<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Createlist</title>
    <link rel="stylesheet" href="./css/userupdate.css">
</head>

<body>

    <form id="updateForm" class="login-form">
        <h1>Update user</h1>

        <div class="txtb">

            <input type="text" id="inpUsername" placeholder="Username">

            <input type="text" id="inpEmail" placeholder="Email">

            <input type="password" id="inpNewPass" placeholder="New Password">

            <input type="password" id="inpNewPass2" placeholder="New Password">

            <input type="password" id="inpOldPass" placeholder="Old Password*">
        </div>

        <button id="btnCreate" type="submit">Change</button>
    </form>

</body>

<script>

    let uname = document.getElementById("inpUsername");
    let email = document.getElementById("inpEmail");
    let oldPass = document.getElementById("inpOldPass");
    let newPass = document.getElementById("inpNewPass");
    let newPassAgain = document.getElementById("inpNewPass2");

    let updateForm = document.getElementById("updateForm");

    let logindata = JSON.parse(sessionStorage.getItem("logindata"));
    if (!logindata) {
        window.location.href = "./userlogin.html";
    }

    // --------------------------------------- 
    updateForm.addEventListener("submit", async function (evt) {
        evt.preventDefault();

        if (newPass.value.localeCompare(newPassAgain.value) != 0) {
            newPassAgain.style = "border-color: red";
            return;
        }

        let token = logindata.token;

        let url = "http://localhost:3000/users";

        let updata = {
            username: uname.value,
            email: email.value,
            newpass: newPass.value,
            oldpass: oldPass.value
        }

        let cfg = {
            method: "PUT",
            headers: {
                "Content-Type": "application/json"
                , "authorisation": token
            },
            body: JSON.stringify(updata)
        }

        try {

            var resp = await fetch(url, cfg);
            var data = await resp.json();

            if (resp.status == 403) {
                window.location.href = "./userlogin.html";
                return;
            } else if (resp.status > 202) {
                throw (data);
            }
            window.location.href = "./user.html";

        } catch (err) {
            console.log(err);
            if (err.msg) {
                txtResult.innerHTML = err.msg;
            }
        }

    });



</script>

</html>